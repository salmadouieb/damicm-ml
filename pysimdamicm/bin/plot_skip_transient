#!/usr/bin/env python3

import numpy as np
import ROOT
from astropy.io import fits
from array import array
import math
#import matplotlib
#from matplotlib import style
#font = {'size'   : 15
#        }
#matplotlib.rc('font', **font)
#

#from matplotlib import pyplot as plt
def get_Nbins(data):
    n = data.size
    p25, p75 = np.percentile(data, [25, 75])
    width = 2. * (p75 - p25)/n**(1./3)
    nbins = math.ceil((data.max() - data.min()) / width)
    nbins = max(1, nbins)

    return nbins

def main(infile, rows, cols , ext, hext):
    image = read_image(infile, ext, hext)
    

    tg = []
    th = []
    legtg = ROOT.TLegend()
    tmean = []
    for amp in image.keys():
        xval = array('d',np.linspace(1,image[amp].shape[2],image[amp].shape[2]))

        tmean.append( ROOT.TGraph(len(xval), xval, array('d', image[amp].mean(axis=0).mean(axis=0).reshape(-1,1))) )

        for r in rows:
            r=int(r)
            for c in cols:
                c=int(c)
                yval = image[amp][r,c,:].reshape(-1,1)
                tg.append(ROOT.TGraph(len(xval), xval, array('d',yval)))
                legtg.AddEntry(tg[-1],f"{r},{c}: {np.mean(yval)}","PL")
                
                nbins = get_Nbins(yval)
                th.append( ROOT.TH1D(f"h_r{r}c{c}",f"h_r{r}c{c}",nbins, yval.min()-5, yval.max()+5 ) )
                for yi in image[amp][r,c,:]:
                    th[-1].Fill(yi)

    c0 = ROOT.TCanvas()
    opt = "AL PLC PMC"
    for g in tmean:
        g.GetHistogram().SetXTitle("NDCM")
        g.GetHistogram().SetYTitle("q_{mean}")
        g.SetMarkerSize(0.8)
        g.SetMarkerStyle(20)
        g.Draw(opt)
        opt="L PLC PMC SAME"
    c0.Update()
    c0.Draw()

    c = ROOT.TCanvas()
    opt = "AL PLC PMC"
    for g in tg:
        g.GetHistogram().SetXTitle("NDCM")
        g.GetHistogram().SetYTitle("pixel charge [ADUs]")
        g.SetMarkerSize(0.8)
        g.SetMarkerStyle(20)
        g.Draw(opt)
        opt="L PLC PMC SAME"
    legtg.Draw("same")
    c.Update()
    c.Draw()

    c2 = ROOT.TCanvas()
    opt = "HIST PLC"
    for h in th:
        h.SetYTitle("counts")
        h.SetXTitle("pixel charge [ADUs]")
        h.SetLineWidth(2)
        h.Draw(opt)
        opt="HIST PLC SAME"
    legtg.Draw("same")
    c2.Update()
    c2.Draw()

    input()

    return image

def read_image(infile,ext,hext):
    h = fits.getheader(infile,hext)
    try:
        n_amp = len(h['AMPL'].strip())
    except KeyError:
        print("Keyword 'AMPL' not found. Assuming only 1 amplifier has been used during readout")
        n_amp = 1
    try:
        skips = int(h['NDCMS'])
    except KeyError:
        skips = int(h['NSAMP'])

    # get data
    img = fits.getdata(infile,ext)
    rows,cols = img.shape

    image = {}
    if n_amp==1:
        image['L'] = img.reshape(rows,cols//skips,skips)

    if n_amp==2:
        img = img.reshape(rows,cols//skips,skips)
        image['L'] = img[:,:cols//skips//2,:]
        image['U'] = np.flip( np.flip( img[:,cols//skips//2:,:], axis=2), axis=1)

    return image


##########################################################################
if __name__ == '__main__':
    import sys

    import argparse
    parser = argparse.ArgumentParser()

    parser.add_argument(
            action='store',
            dest='infile',
            help='fits file name for an image taken with several skips')

    parser.add_argument('-r',
            action='store',
            dest='rows',
            nargs='+',
            help='list of rows for a pixel to be selected'
            )

    parser.add_argument('-c',
            action='store',
            dest='cols',
            nargs='+',
            help='list of columns  for a pixel to be selected'
            )

    parser.add_argument('--ext',
            action='store',
            dest='extensions',
            nargs='+',
            default=[0,0],
            help='Extension IDs for header and data, respectively'
            )

    args = parser.parse_args(args=None if sys.argv[1:] else ['--help'])

    rows = list(sorted(map(int,args.rows)))
    cols = list(sorted(map(int,args.cols)))
    ext, hext = map(int,args.extensions)
    main(args.infile,rows,cols,ext,hext)


